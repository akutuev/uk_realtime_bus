 <!doctype html>
<html lang="en">
  <head>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.2.1/css/ol.css" type="text/css">
    <style>
      html, body {
        width: 100%;
        height: 100%;
      }

      .map {
        width: 90%;
        height: 100%;
        border: 1px solid #ccc;
      }

      #info {
        position: absolute;
        display: inline-block;
        height: auto;
        width: auto;
        z-index: 100;
        background-color: #fff;
        color: #000;
        text-align: left;
        border-radius: 4px;
        padding: 15px;
        left: 50%;
        transform: translateX(3%);
        visibility: hidden;
        pointer-events: none;
      }
    </style>
    <script src="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.2.1/build/ol.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <title>Didcot Buses</title>
  </head>
  <body>
    <h2>Didcot Buses</h2>
    <div class="bus_info" id="bus_info"></div>
    <div id="map" class="map">
        <div id="info"></div>
    </div>
    <script type="text/javascript">

        $.ajax({
            type: 'GET',
            url: '/buses',
            headers: {
                'Content-Type': 'application/json',
            },
            dataType: 'json',
            success: function(responseData, textStatus, jqXHR) {
                loadMap(responseData);
            },
            error: function (responseData, textStatus, errorThrown) {
                alert('request failed.');
            }
        });

       function loadMap(data) {
            console.dir(data);   

            const features = [];
            for(let i = 0; i < data.length; i++) {
                var bus = data[i];

                var warning = bus.inService === true ? "" : "&#9888<b> Arrival time is over. Bus might be not in service </b>&#9888"
                
                features.push(
                    new ol.Feature({
                        geometry: new ol.geom.Point(
                            ol.proj.fromLonLat([
                            bus.longitude, bus.latitude
                            ])),
                        text: bus.bus_service_name,
                        details: 
                            "Vehicle Ref: " + bus.vehicleRef + "</br>" +
                            "Direction: " + bus.originName + " &rarr; " + bus.destinationName + "</br>" +
                            "Aimed time: " + bus.originAimedDepartureTime + " &rarr; " + bus.destinationAimedArrivalTime + "</br>" +
                            warning        
                    }));
                }

            const vectorSource = new ol.source.Vector({
                features
            });

            const style = new ol.style.Style({
                image: new ol.style.Circle({
                    radius: 12,
                    stroke: new ol.style.Stroke({
                        color: 'black'
                    }),
                    fill: new ol.style.Fill({
                        color: '#FF0000'
                    })
                }),
                text: new ol.style.Text({
                        font: '10px Calibri,sans-serif',
                        fill: new ol.style.Fill({ color: '#000' }),
                        offsetY: 0,
                    })
                });

            const vectorLayer = new ol.layer.Vector({
                source: vectorSource,
                style: function (feature) {
                    style.getText().setText(feature.get('text'));
                    return style;
                }
            });

            const map = new ol.Map({
                target: 'map',
                layers: [
                    new ol.layer.Tile({
                        source: new ol.source.OSM()
                    }),
                    vectorLayer
                ],
                view: new ol.View({
                center: ol.proj.fromLonLat([-1.271189,51.605066]),
                zoom: 15
                })
            });

            const info = document.getElementById('info');
            map.on('pointermove', function (evt) {
                if (evt.dragging) {
                    info.style.visibility = 'hidden';
                    currentFeature = undefined;
                    return;
                }
                displayFeatureInfo(evt.pixel, evt.originalEvent.target);
            });

            const bus_info = document.getElementById('bus_info');
            map.on('click', function(event) {
                map.forEachFeatureAtPixel(event.pixel, function(feature,layer) {
                    bus_info.innerHTML = feature.get('details');
                });
            }); 
            
            const displayFeatureInfo = function (pixel, target) {
                const feature = target.closest('.ol-control')
                    ? undefined
                    : map.forEachFeatureAtPixel(pixel, function (feature) {
                        return feature;
                    });
                if (feature) {
                    info.style.left = pixel[0] + 'px';
                    info.style.top = pixel[1] + 'px';
                    if (feature !== currentFeature) {
                        info.style.visibility = 'visible';
                        info.innerHTML = feature.get('details');
                    }
                } else {
                    info.style.visibility = 'hidden';
                }
                currentFeature = feature;
            };
    }



    </script>
  </body>
</html>